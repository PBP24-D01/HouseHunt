{% extends 'base.html' %}

{% block meta %}<title>Auction | {{auction.title}}</title>{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">{{ auction.title }}</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h2 class="text-xl font-semibold mb-4">House Details</h2>
                    <div class="space-y-2">
                        <p><span class="font-medium">Location:</span> {{ auction.house_address }}</p>
                        <p><span class="font-medium">Description:</span> {{ auction.house_description }}</p>
                    </div>
                </div>
                
                <div>
                    <h2 class="text-xl font-semibold mb-4">Auction Information</h2>
                    <div class="space-y-2">
                        <p><span class="font-medium">Start Date:</span> {{ auction.start_date }}</p>
                        <p><span class="font-medium">End Date:</span> {{ auction.end_date }}</p>
                        <p><span class="font-medium">Starting Price:</span> ${{ auction.starting_price }}</p>
                        <p><span class="font-medium">Current Price:</span> ${{ auction.current_price }}</p>
                        {% if auction.highest_buyer %}
                            <p><span class="font-medium">Highest Bidder:</span> {{ auction.highest_buyer }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if user.buyer.user.username and auction.is_active %}
                <div class="border-t pt-6">
                    <h2 class="text-xl font-semibold mb-4">Place Your Bid</h2>
                    <form id="bidForm" class="space-y-4" data-auction-id="{{ auction.id }}">
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700">Your Bid Amount ($)</label>
                            <input type="number" id="price" name="price" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                   min="{{ auction.current_price|add:'1' }}" required>
                        </div>
                        <button type="submit" 
                                class="w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-300">
                            Place Bid
                        </button>
                    </form>
                </div>

                <script>
                    document.getElementById('bidForm').addEventListener('submit', async (e) => {
                        const auctionId = document.getElementById('bidForm').getAttribute('data-auction-id');
                        e.preventDefault();
                        try {
                            const response = await fetch(`/auction/bid/${auctionId}`, {
                                method: 'POST',
                                body: new FormData(e.target)
                            });
                            if (response.ok) {
                                location.reload();
                            } else {
                                const error = await response.text();
                                alert(error);
                            }
                        } catch (error) {
                            alert('Error placing bid. Please try again.');
                        }
                    });
                </script>
            {% endif %}

            {% if user.seller.user.username == auction.seller and not auction.is_active %}
                <div class="flex space-x-4 mt-6">
                    <a href="/auction/edit/{{ auction.id }}" 
                       class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-300">
                        Edit Auction
                    </a>
                    <button
                       class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 transition duration-300"
                          id='deleteAuction' data-auction-id="{{ auction.id }}">
                        Delete Auction
                    </button>
                </div>
                <script>
                    const deleteAuction = async (auctionId) => {
                        if (!confirm('Are you sure you want to delete this auction?')) {
                            return;
                        }
                        try {
                            const response = await fetch(`/auction/delete/${auctionId}`, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}'
                                }
                            });
                            if (response.ok) {
                                location.href = '/auction';
                            } else {
                                const error = await response.text();
                                alert(error);
                            }
                        } catch (error) {
                            alert('Error deleting auction. Please try again.');
                        }
                    }
                
                    document.getElementById('deleteAuction').addEventListener('click', () => {
                        const auctionId = document.getElementById('deleteAuction').getAttribute('data-auction-id');
                        deleteAuction(auctionId);
                    });
                </script>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}